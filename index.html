<body>
    <header>
        <nav>
            <div class="nav-wrapper">
                <a href="#" class="brand-logo center">
                    <i class="material-icons">layers</i>
                    PorcelanatoPlus
                </a>
            </div>
        </nav>
    </header>

    <main>
        <div class="container">
            <div class="card" id="inputForm">
                <div class="card-content">
                    <span class="card-title">Controle de Tonalidade</span>
                    <p>Preencha os dados do produto para gerar o relatório de avaliação</p>

                    <div class="row">
                        <div class="input-field col s12">
                            <i class="material-icons prefix">person</i>
                            <input id="responsavel" type="text" class="validate">
                            <label for="responsavel">Responsável pela Avaliação</label>
                        </div>
                    </div>

                    <div class="row">
                        <div class="input-field col s12">
                            <i class="material-icons prefix">inventory_2</i>
                            <input id="produto" type="text" class="validate">
                            <label for="produto">Nome do Produto</label>
                        </div>
                    </div>

                    <div class="row">
                        <div class="input-field col s12">
                            <i class="material-icons prefix">aspect_ratio</i>
                            <input id="formato" type="text" class="validate">
                            <label for="formato">Formato (ex: 60x60 cm)</label>
                        </div>
                    </div>

                    <div class="row">
                        <div class="input-field col s12">
                            <i class="material-icons prefix">grading</i>
                            <select id="situacao">
                                <option value="" disabled selected>Escolha a situação</option>
                                <option value="Letra">Letra</option>
                                <option value="Número">Número</option>
                            </select>
                            <label>Tipo de Avaliação</label>
                        </div>
                    </div>

                    <div class="justificativa-container hidden" id="justificativaContainer">
                        <div class="row">
                            <div class="input-field col s12">
                                <i class="material-icons prefix">feedback</i>
                                <textarea id="justificativa" class="materialize-textarea validate" data-length="500"></textarea>
                                <label for="justificativa">Justificativa da Avaliação Numérica (mínimo 10 caracteres)</label>
                                <div class="char-counter" id="charCounter">0/10 caracteres</div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col s12 center">
                            <button class="btn waves-effect waves-light" id="addProductBtn">
                                <i class="material-icons left">add</i>
                                Adicionar Produto
                            </button>
                        </div>
                    </div>

                    <div class="product-header">
                        <h5>Produtos Adicionados</h5>
                        <span id="productCount">0 produto(s)</span>
                    </div>

                    <div class="products-container" id="productsContainer">
                        <div class="no-products" id="noProducts">Nenhum produto adicionado</div>
                    </div>

                    <div class="row">
                        <div class="col s12 center">
                            <button class="btn waves-effect waves-light" id="generateBtn">
                                <i class="material-icons left">description</i>
                                Gerar Relatório
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card hidden" id="reportCard">
                <div class="card-content">
                    <span class="card-title">Relatório de Qualidade</span>
                    <p>Relatório gerado para o controle de qualidade do produto</p>

                    <div id="reportPreview">
                        <div class="report-section">
                            <span class="report-label">Responsável:</span>
                            <span id="previewResponsavel"></span>
                        </div>

                        <div class="report-section">
                            <span class="report-label">Data e Hora:</span>
                            <span id="previewData"></span>
                        </div>

                        <div class="report-section">
                            <span class="report-label">Produtos:</span>
                            <div id="previewProducts"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div class="fixed-action-btn">
        <a class="btn-floating btn-large grey darken-2">
            <i class="large material-icons">menu</i>
        </a>
        <ul>
            <li>
                <a class="btn-floating green hidden" id="whatsappBtn" title="Enviar por WhatsApp">
                    <i class="material-icons">send</i>
                </a>
            </li>
            <li>
                <a class="btn-floating blue hidden" id="viewReportBtn" title="Visualizar Relatório">
                    <i class="material-icons">visibility</i>
                </a>
            </li>
            <li>
                <a class="btn-floating grey" id="newReportBtn" title="Novo Relatório">
                    <i class="material-icons">add</i>
                </a>
            </li>
        </ul>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>

    <script>
        $(document).ready(function(){
            // Inicializar componentes do Materialize
            $('select').formSelect();
            $('#justificativa').characterCounter();
            $('.fixed-action-btn').floatingActionButton({
                direction: 'top',
                hoverEnabled: false
            });

            // Array para armazenar os produtos
            let products = [];

            // Mostrar/ocultar campo de justificativa conforme seleção
            $('#situacao').change(function(){
                if ($(this).val() === 'Número') {
                    $('#justificativaContainer').removeClass('hidden');
                } else {
                    $('#justificativaContainer').addClass('hidden');
                    $('#justificativa').val('');
                    $('#charCounter').removeClass('invalid');
                }
            });

            // Validar tamanho da justificativa em tempo real
            $('#justificativa').on('input', function(){
                const length = $(this).val().length;
                const counter = $('#charCounter');

                counter.text(`${length}/10 caracteres`);

                if (length > 0 && length < 10) {
                    counter.addClass('invalid');
                } else {
                    counter.removeClass('invalid');
                }
            });

            // Adicionar produto
            $('#addProductBtn').click(function(){
                const produto = $('#produto').val().trim();
                const formato = $('#formato').val().trim();
                const situacao = $('#situacao').val();
                const justificativa = $('#justificativa').val().trim();

                // Validar campos obrigatórios
                if(!produto || !formato || !situacao) {
                    M.toast({html: 'Por favor, preencha todos os campos do produto!', classes: 'red'});
                    return;
                }

                // Validar justificativa se for avaliação numérica
                if(situacao === 'Número' && justificativa.length < 10) {
                    M.toast({html: 'A justificativa deve ter pelo menos 10 caracteres!', classes: 'red'});
                    return;
                }

                // Adicionar produto ao array
                const product = {
                    nome: produto,
                    formato: formato,
                    situacao: situacao,
                    justificativa: situacao === 'Número' ? justificativa : ''
                };

                products.push(product);

                // Atualizar a lista de produtos
                updateProductsList();

                // Limpar campos do produto
                $('#produto, #formato, #justificativa').val('');
                $('#situacao').val('');
                $('select').formSelect();
                $('#justificativaContainer').addClass('hidden');
                $('#charCounter').removeClass('invalid').text('0/10 caracteres');

                M.toast({html: 'Produto adicionado com sucesso!', classes: 'green'});
            });

            // Atualizar a lista de produtos na UI
            function updateProductsList() {
                const container = $('#productsContainer');
                const noProducts = $('#noProducts');
                const productCount = $('#productCount');

                productCount.text(products.length + ' produto(s)');

                if (products.length === 0) {
                    noProducts.removeClass('hidden');
                    container.html('<div class="no-products" id="noProducts">Nenhum produto adicionado</div>');
                    return;
                }

                noProducts.addClass('hidden');
                let html = '';

                products.forEach((product, index) => {
                    html += `
                        <div class="product-item">
                            <i class="material-icons remove-product" data-index="${index}">delete</i>
                            <div><strong>${product.nome}</strong></div>
                            <div>Formato: ${product.formato}</div>
                            <div>Situação: ${product.situacao}</div>
                            ${product.situacao === 'Número' ? `<div>Justificativa: ${product.justificativa}</div>` : ''}
                        </div>
                    `;
                });

                container.html(html);

                // Adicionar evento de remoção
                $('.remove-product').click(function() {
                    const index = $(this).data('index');
                    products.splice(index, 1);
                    updateProductsList();
                    M.toast({html: 'Produto removido!', classes: 'green'});
                });
            }

            // Gerar relatório
            $('#generateBtn').click(function(){
                const responsavel = $('#responsavel').val().trim();

                // Validar campos
                if(!responsavel) {
                    M.toast({html: 'Por favor, informe o responsável!', classes: 'red'});
                    return;
                }

                if(products.length === 0) {
                    M.toast({html: 'Por favor, adicione pelo menos um produto!', classes: 'red'});
                    return;
                }

                // Atualizar preview
                $('#previewResponsavel').text(responsavel);

                // Data e hora atual
                const agora = new Date();
                const dataHora = agora.toLocaleString('pt-BR', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                $('#previewData').text(dataHora);

                // Adicionar produtos ao preview
                let productsHtml = '';
                products.forEach((product, index) => {
                    productsHtml += `
                        <div class="product-item">
                            <div><strong>Produto ${index + 1}:</strong> ${product.nome}</div>
                            <div>Formato: ${product.formato}</div>
                            <div>Situação: ${product.situacao}</div>
                            ${product.situacao === 'Número' ? `<div>Justificativa: ${product.justificativa}</div>` : ''}
                        </div>
                    `;
                });

                $('#previewProducts').html(productsHtml);

                // Mostrar relatório e botões
                $('#reportCard').removeClass('hidden');
                $('#viewReportBtn, #whatsappBtn').removeClass('hidden');

                // Scroll para o relatório
                $('html, body').animate({
                    scrollTop: $('#reportCard').offset().top
                }, 500);
            });

            // Novo relatório
            $('#newReportBtn').click(function(){
                // Limpar formulário
                $('#responsavel, #produto, #formato, #justificativa').val('');
                $('#situacao').val('');
                $('select').formSelect();
                $('#justificativaContainer').addClass('hidden');
                $('#charCounter').removeClass('invalid').text('0/10 caracteres');

                // Limpar produtos
                products = [];
                updateProductsList();

                // Ocultar relatório
                $('#reportCard').addClass('hidden');
                $('#viewReportBtn, #whatsappBtn').addClass('hidden');

                // Scroll para o topo
                window.scrollTo(0, 0);
            });

            // Visualizar relatório
            $('#viewReportBtn').click(function(){
                if(!$('#reportCard').hasClass('hidden')) {
                    $('html, body').animate({
                        scrollTop: $('#reportCard').offset().top
                    }, 500);
                }
            });

            // Enviar por WhatsApp
            $('#whatsappBtn').click(function(){
                // Verificar se o relatório foi gerado
                if($('#reportCard').hasClass('hidden')) {
                    M.toast({html: 'Gere um relatório primeiro!', classes: 'red'});
                    return;
                }

                const responsavel = $('#previewResponsavel').text();
                const data = $('#previewData').text();

                // Montar texto do relatório
                let texto = `*Relatório de Tonalidade*\n\n` +
                              `*Responsável:* ${responsavel}\n` +
                              `*Data e Hora:* ${data}\n\n` +
                              `*Produtos Avaliados:*\n\n`;

                // Adicionar cada produto
                products.forEach((product, index) => {
                    texto += `*Produto ${index + 1}:*\n`;
                    texto += `Nome: ${product.nome}\n`;
                    texto += `Formato: ${product.formato}\n`;
                    texto += `Situação: ${product.situacao}\n`;

                    if (product.situacao === 'Número') {
                        texto += `Justificativa: ${product.justificativa}\n`;
                    }

                    texto += `\n`;
                });

                texto += `_Relatório gerado pelo sistema de tonalidade_`;

                // Codificar para URL
                const textoCodificado = encodeURIComponent(texto);

                // Gerar link do WhatsApp
                const url = `https://wa.me/?text=${textoCodificado}`;

                // Abrir WhatsApp
                window.open(url, '_blank');
            });
        });
    </script>
</body>
</html>